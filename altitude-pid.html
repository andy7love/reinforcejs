<!doctype html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Altitude</title>
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <!-- jquery and jqueryui -->
  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <link href="external/jquery-ui.min.css" rel="stylesheet">
  <script src="external/jquery-ui.min.js"></script>

  <!-- bootstrap -->
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

  <!-- d3js -->
  <script type="text/javascript" src="external/d3.min.js"></script>

  <!-- rljs -->
  <script type="text/javascript" src="lib/rl.js"></script>

  <!-- flotjs -->
  <script src="external/smoothie.js"></script>

  <!-- pid.js -->
  <script type="text/javascript" src="pid.js"></script>

  <style>
    body {
      background-color: black;
      color: grey;
    }
  </style>
  
  <script type="application/javascript">
    // charts
    var positionSerie = new TimeSeries();
    var targetSerie = new TimeSeries();
    var throttleSerie = new TimeSeries();
    var rewardsSerie = new TimeSeries();

    function currentTime() {
        return new Date().getTime();
    }

    function clamp(value) {
      if(value > 1) {
        value = 1;
      } else if(value < -1) {
        value = -1;
      }
      return value;
    };

    function clampInt(value) {
      if(value > 1) {
        value = 1;
      } else if(value < 0) {
        value = 0;
      }
      return value;
    };

    function createTimeline() {
        var chart = new SmoothieChart();
        chart.addTimeSeries(positionSerie, { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 2 });
        chart.addTimeSeries(targetSerie, { strokeStyle: 'rgba(255, 0, 0, 1)', fillStyle: 'rgba(255, 0, 0, 0.1)', lineWidth: 2 });
        chart.streamTo(document.getElementById("altitude"), 500);

        chart = new SmoothieChart({minValue: 0, maxValue: 1});
        chart.addTimeSeries(throttleSerie, { strokeStyle: 'rgba(0, 0, 255, 1)', fillStyle: 'rgba(0, 0, 255, 0.2)', lineWidth: 2 });
        chart.streamTo(document.getElementById("throttle"), 500);

        chart = new SmoothieChart({ minValue: -2, maxValue: 2 });
        chart.addTimeSeries(rewardsSerie, { strokeStyle: 'rgba(200, 200, 0, 1)', fillStyle: 'rgba(200, 200, 0, 0.2)', lineWidth: 2 });
        chart.streamTo(document.getElementById("rewards"), 500);
    }

    // Drone
    function Drone() {
        this.y = 0;
        this.verticalSpeed = 0;
        this.throttle = 0;

        this.pid = new Controller({
          k_p: 2,
          k_i: 0.5,
          k_d: 0.1
        });

        this.setTarget = (newTarget) => {
          this.pid.setTarget(newTarget);
        }

        this.action = () => {
          this.throttle = clampInt(this.pid.update(this.y));
        }
    }

    // World
    function World() {
        this.gravity = -9.8;
        this.airPressureDecreaseGradient = 0;
    }

    function start() {
        createTimeline();

        var drone = new Drone();
        var world = new World();
        var fps = 60;
        var interval = Math.round((1/fps)*1000);
        var earthTickForce = world.gravity/fps;
        var throttleToForceFactor = 15;
        var ticks = 0;

        var tick = () => {
            // get target
            var currentTarget = parseFloat($('#targetSlider').val());
            var prevAltitude = drone.y;

            // apply action
            drone.setTarget(currentTarget);
            drone.action();

            // apply physics
            var motorsTickForce = (drone.throttle * throttleToForceFactor) / fps;
            drone.verticalSpeed = drone.verticalSpeed + earthTickForce + motorsTickForce;
            drone.y = drone.y + drone.verticalSpeed;

            // touch floor.
            if(drone.y < 0) {
                drone.verticalSpeed = 0;
                drone.y = 0; 
            }

            // plot
            var time = currentTime();
            positionSerie.append(time, drone.y);
            targetSerie.append(time, currentTarget);
            throttleSerie.append(time, drone.throttle);
            //rewardsSerie.append(time, reward);

            setTimeout(() => {
                ticks++;
                tick();
            }, interval);
        }

        tick();
    }
  </script>
 </head>
 <body onload="start();">
    <input type="range" name="target" id="targetSlider" min="0" max="2" value="1" step="0.0001" />
    <h5>Altitude / Target</h5>
    <canvas id="altitude" width="700" height="270"></canvas>

    <h5>Throttle</h5>
    <canvas id="throttle" width="700" height="270"></canvas>

    <h5>Reward score</h5>
    <canvas id="rewards" width="700" height="270"></canvas>
 </body>
</html>
